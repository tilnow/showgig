<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 400px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/build/ol.js"></script>
    <title>Testing idea for add-a-gig</title>
  </head>

<body>
<p>
the idea is to try and optimize a display of available gigs based on two assumptions:
<br>
1. gig lookers from the yak collective are interested in particular types of information (hope i got them right... pls advise)
<br>
2. a graphical display helps expose some of the information in a way that is easy for a gig searcher to assimilate and use for fast filtering <br>
*at this time, i do not have a good model for "looking for a gig" entries<br>
<br>
</p>
<p>
how to use?<br>
in map select a map size people can recognize and mark the approximate geographical region where gig-takers may reasonably come from. you can minimize the map to cover the entire world, too.<br>
use sliders to select the relative amount of each of the properties of the gig<br>
write a short decsription of the gig. use hashmarks ("#") to indicate keywords that should stand out. it is not unreasonable to expect that text in html will be treated as html (at least in future, but not in unfurl view).<br>
</p>

<p>
logic:<br>
on this page you may enter a gig<br>
once posted, it gets a gig number and a dedicated page/link<br>
each gig also has an unfurl format, which includes the graphics, the keywords and the description<br>
someday there will be a page for seeing a list of the gigs<br>
i am not implementing editing, logging in etc., as this is not a production system, just a demo of the display<br>


</p>
<p><b>time considerations</b></p><br>
<label for="param_0">duration; low to high:</label>
<input type="range" id="param_6" name="points" min="0" max="10"><br>
<label for="param_1">intensity; low to high:</label>
<input type="range" id="param_7" name="points" min="0" max="10"><br>
<br>
<p><b>style considerations</b></p><br>
<label for="param_2">effort volatility; low to high:</label>
<input type="range" id="param_0" name="points" min="0" max="10"><br>
<label for="param_3">work vs. talk balance:</label>
<input type="range" id="param_1" name="points" min="0" max="10"><br>
<br><p><b>subject matter considerations</b> (i only mean to cover most common skill sets looked for)</p><br>
<label for="param_4">software:</label>
<input type="range" id="param_2" name="points" min="0" max="10"><br>
<label for="param_5">words:</label>
<input type="range" id="param_3" name="points" min="0" max="10"><br>
<label for="param_6">management:</label>
<input type="range" id="param_4" name="points" min="0" max="10"><br>
<label for="param_7">visual:</label>
<input type="range" id="param_5" name="points" min="0" max="10"><br>
<script>
function slider_onchange(){
    v=this.value;
    n=this.id.split("_")[1];
    myRadarChart.data.datasets[0].data[n]=v;
    myRadarChart.update();
}
for (let i = 0; i < 8; i++){
document.getElementById("param_"+i.toString()).onchange=slider_onchange;
}
function done(){  
spider_url=myRadarChart.toBase64Image();
}
data= {
    labels: [ 'StD', 'talk','s/w','words','mangment','visual','duration', '%week'],
    datasets: [{
        label:"lets try to hide this",
        data: [9, 10, 4, 2 , 10, 5,8,9],
        borderColor: "red",
        fill: false
        
    }]
}
options = {
  animation: {
    onComplete: done,
  },
    legend:{
        display: false,
    },
    scale: {
        angleLines: {
            display: false
        },
    pointLabels:{
        display: true //lets play with this
    },
        ticks: {
            display:false,
            suggestedMin: 1,
            suggestedMax: 11
        }
    }
};
</script>
<p><b>This radar chart graphically illustrates the above selected parameters</b></p><br>
<div class="chart-container" style="position: relative; height:400px; width:600px">
<canvas id="myChart"></canvas>
</div>

title:<textarea id="title" name="title" rows="1" cols="100" placeholder="brief title"></textarea><br>
body:<textarea id="body" name="body" rows="7" cols="100" placeholder="description of gig, add #hashtags to keywords"></textarea><br>

    <div id="map" class="map"></div>
        <form class="form-inline">
      <label>Shape type &nbsp;</label>
      <select id="type">
        <option value="Circle">Circle</option>
        <option value="Square">Square</option>
        <option value="Box">Box</option>
        <option value="None">None</option>
      </select>
    </form>
    <button id="makeagig" >please post my gig</button><br>
    <script type="text/javascript">

    
var raster = new ol.layer.Tile({
  source: new ol.source.OSM()
});

var source = new ol.source.Vector({wrapX: false});

var vector = new ol.layer.Vector({
  source: source
});
    
    
      var map = new ol.Map({
        target: 'map',
        layers: [raster,vector],
        view: new ol.View({
          center: ol.proj.fromLonLat([37.41, 8.82]),
          zoom: 0.1
        })
      });
      var typeSelect = document.getElementById('type');

var draw; // global so we can remove it later
function addInteraction() {
  var value = typeSelect.value;
  if (value !== 'None') {
    var geometryFunction;
    if (value === 'Square') {
      value = 'Circle';
      geometryFunction = createRegularPolygon(4);
    } else if (value === 'Box') {
      value = 'Circle';
      geometryFunction = createBox();
    } 
    draw = new ol.interaction.Draw({
      source: source,
      type: value,
      geometryFunction: geometryFunction
    });
    map.addInteraction(draw);
  }
}


/**
 * Handle change event.
 */
typeSelect.onchange = function() {
  map.removeInteraction(draw);
  addInteraction();
};

addInteraction();

    </script>


<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
var cnv=document.getElementById('myChart');
var ctx = cnv.getContext('2d');
//for images see https://stackoverflow.com/questions/36979474/how-to-change-the-labels-to-the-image-icon-in-bar-chart-js

var myRadarChart = new Chart(ctx, {
    type: 'radar',
    data: data,
    options: options
});

//cnv.style.height="100px";
//cnv.style.width="100px";
var spider_url,map_url;



function posting() {
  map.once('rendercomplete', async function() {
    var mapCanvas = document.createElement('canvas');
    var size = map.getSize();
    mapCanvas.width = size[0];
    mapCanvas.height = size[1];
    var mapContext = mapCanvas.getContext('2d');
    Array.prototype.forEach.call(document.querySelectorAll('.ol-layer canvas'), function(canvas) {
      if (canvas.width > 0) {
        var opacity = canvas.parentNode.style.opacity;
        mapContext.globalAlpha = opacity === '' ? 1 : Number(opacity);
        var transform = canvas.style.transform;
        // Get the transform parameters from the style's transform matrix
        var matrix = transform.match(/^matrix\(([^\(]*)\)$/)[1].split(',').map(Number);
        // Apply the transform to the export map context
        CanvasRenderingContext2D.prototype.setTransform.apply(mapContext, matrix);
        mapContext.drawImage(canvas, 0, 0);
      }
    });
    
      map_url = mapCanvas.toDataURL();//we are assuming that by now teh chart finished drawing and generating image file. it is a race condition
    var formData = new FormData();
    //for now allow map url to be generated manually, spider url is probably generated automatically
    let map_file = await fetch(map_url).then(r => r.blob()).then(blobFile => new File([blobFile], "map.png", { type: "image/png" }));
    let spider_file = await fetch(spider_url).then(r => r.blob()).then(blobFile => new File([blobFile], "spider.png", { type: "image/png" }));

  formData.append('map_file', map_file);
  formData.append('spider_file', spider_file);
  formData.append('title', document.getElementById("title").value);
  formData.append('body', document.getElementById("body").value);

  fetch('/makeagig', {
    // content-type header should not be specified!

    method: 'POST',
    body: formData,
  }).then(response=>{       if (response.redirected) {
            window.location.href = response.url;
        }}).catch(error=>alert(error));
  });
  map.renderSync();
  
}

document.getElementById("makeagig").addEventListener("click",posting);

</script>


</body>
</html>