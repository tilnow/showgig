<html>
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 400px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.3.1/build/ol.js"></script>
    <title>Testing idea for add-a-gig</title>
  </head>

<body>
<p>
the idea is to try and optimize a display of available gigs based on two assumptions:
<br>
1. gig lookers are intersted in particular types of information (hope i got them right...)
<br>
2. a graphical display helps expose some of the data in a way that is easy for a gig searcher to assimilate and use for fast filtering <br>

at thsi time, i do not have a good model for "looking for a gig" entries<br>
<br>
</p>
<p>
how to use?<br>
in map select a map size peopel can regognize and mark teh approximate geoegraphical region where gig-takers may reasonably come from. you can minimize the map to cover the entire world, too.<br>
use sliders to select the relative amount of each of the properties of the gig<br>
write a short decsription of the gig. use hashmarks ("#') to indicate keywords that should stand out. it is not unreasonable to expect that text in html will be treated as html (at least in future).<br>
</p>

<p>
logic:<br>
on this page you may enter a gig<br>
once posted, it gets a gig number and a dedicated page/link<br>
each gig also has an unfurl format, which includes the graphics, the keywords and the description<br>
someday there will be a page for seeing a list of the gigs<br>
i am not implementing editing, logging in etc., as this is not a production system, just a demo of the display<br>


</p>

<button id="makeagig" >make a gig</button><br>
title:<textarea id="title" name="title" rows="1" placeholder="title"></textarea><br>
body:<textarea id="body" name="body" rows="7" placeholder="description of gig"></textarea><br>

    <div id="map" class="map"></div>
    <button id="export-png" class="btn btn-default"><i class="fa fa-download"></i> Download PNG</button>
    <a id="image-download" download="map.png"></a>
        <form class="form-inline">
      <label>Shape type &nbsp;</label>
      <select id="type">
        <option value="Circle">Circle</option>
        <option value="Square">Square</option>
        <option value="Box">Box</option>
        <option value="Star">Star</option>
        <option value="None">None</option>
      </select>
    </form>

    <script type="text/javascript">
/*    import 'ol/ol.css';
import Map from 'ol/Map';
import View from 'ol/View';
import Polygon from 'ol/geom/Polygon';
import Draw, {createRegularPolygon, createBox} from 'ol/interaction/Draw';
import {Tile as TileLayer, Vector as VectorLayer} from 'ol/layer';
import {OSM, Vector as VectorSource} from 'ol/source';
*/
    
    
    var raster = new ol.layer.Tile({
  source: new ol.source.OSM()
});

var source = new ol.source.Vector({wrapX: false});

var vector = new ol.layer.Vector({
  source: source
});
    
    
      var map = new ol.Map({
        target: 'map',
        layers: [raster,vector],
        view: new ol.View({
          center: ol.proj.fromLonLat([37.41, 8.82]),
          zoom: 0.1
        })
      });
      var typeSelect = document.getElementById('type');

var draw; // global so we can remove it later
function addInteraction() {
  var value = typeSelect.value;
  if (value !== 'None') {
    var geometryFunction;
    if (value === 'Square') {
      value = 'Circle';
      geometryFunction = createRegularPolygon(4);
    } else if (value === 'Box') {
      value = 'Circle';
      geometryFunction = createBox();
    } else if (value === 'Star') {
      value = 'Circle';
      geometryFunction = function(coordinates, geometry) {
        var center = coordinates[0];
        var last = coordinates[1];
        var dx = center[0] - last[0];
        var dy = center[1] - last[1];
        var radius = Math.sqrt(dx * dx + dy * dy);
        var rotation = Math.atan2(dy, dx);
        var newCoordinates = [];
        var numPoints = 12;
        for (var i = 0; i < numPoints; ++i) {
          var angle = rotation + i * 2 * Math.PI / numPoints;
          var fraction = i % 2 === 0 ? 1 : 0.5;
          var offsetX = radius * fraction * Math.cos(angle);
          var offsetY = radius * fraction * Math.sin(angle);
          newCoordinates.push([center[0] + offsetX, center[1] + offsetY]);
        }
        newCoordinates.push(newCoordinates[0].slice());
        if (!geometry) {
          geometry = new Polygon([newCoordinates]);
        } else {
          geometry.setCoordinates([newCoordinates]);
        }
        return geometry;
      };
    }
    draw = new ol.interaction.Draw({
      source: source,
      type: value,
      geometryFunction: geometryFunction
    });
    map.addInteraction(draw);
  }
}


/**
 * Handle change event.
 */
typeSelect.onchange = function() {
  map.removeInteraction(draw);
  addInteraction();
};

addInteraction();

    </script>
<!---<img 
    src="world.svg" 
    alt="the map"
    height="200"
    width="200" />
    -->
    <!--<iframe src="world.svg" width="500" height="500" sandbox>
 
</iframe>-->
<!--<a id="download-link">here</a>-->
<canvas id="myChart" width="10000" height="10000" style="width: 1000px;height:1000px;"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
var cnv=document.getElementById('myChart');
var ctx = cnv.getContext('2d');

data= {
    labels: ['Running', 'Swimming', 'Eating', 'Cycling'],
    datasets: [{
        label:"lets try to hide this",
        data: [20, 10, 4, 2],
        borderColor: "red",
        fill: false
        
    }]
}
options = {
  animation: {
    onComplete: done
  },
    legend:{
        display: false,
    },
    scale: {
        angleLines: {
            display: false
        },
    pointLabels:{
        display: false
    },
        ticks: {
            display:false,
            suggestedMin: 10,
            suggestedMax: 30
        }
    }
};
var myRadarChart = new Chart(ctx, {
    type: 'radar',
    data: data,
    options: options
});

//cnv.style.height="100px";
//cnv.style.width="100px";
var spider_url,map_url;

function done(){  
spider_url=myRadarChart.toBase64Image();
}
document.getElementById('export-png').addEventListener('click', generate_map_url());

function generate_map_url() {
  map.once('rendercomplete', function() {
    var mapCanvas = document.createElement('canvas');
    var size = map.getSize();
    mapCanvas.width = size[0];
    mapCanvas.height = size[1];
    var mapContext = mapCanvas.getContext('2d');
    Array.prototype.forEach.call(document.querySelectorAll('.ol-layer canvas'), function(canvas) {
      if (canvas.width > 0) {
        var opacity = canvas.parentNode.style.opacity;
        mapContext.globalAlpha = opacity === '' ? 1 : Number(opacity);
        var transform = canvas.style.transform;
        // Get the transform parameters from the style's transform matrix
        var matrix = transform.match(/^matrix\(([^\(]*)\)$/)[1].split(',').map(Number);
        // Apply the transform to the export map context
        CanvasRenderingContext2D.prototype.setTransform.apply(mapContext, matrix);
        mapContext.drawImage(canvas, 0, 0);
      }
    });
    
      map_url = mapCanvas.toDataURL();
      return map_url
  });
  map.renderSync();
  
}

async function makeagig()
{

    var formData = new FormData();
    //for now allow map url to be generated manually, spider url is probably generated automatically
    let map_file = await fetch(map_url).then(r => r.blob()).then(blobFile => new File([blobFile], "map.png", { type: "image/png" }));
    let spider_file = await fetch(spider_url).then(r => r.blob()).then(blobFile => new File([blobFile], "spider.png", { type: "image/png" }));
  files=[map_file,spider_file];
  console.log(files)
  files.map((file, index) => {
    formData.append(`file${index}`, file);
  });
  
  formData.append('title', document.getElementById("title").value);
  formData.append('body', document.getElementById("body").value);
for (var value of formData.values()) {
   console.log(value);   
  fetch('/makeagig', {
    // content-type header should not be specified!

    method: 'POST',
    body: formData,
  })

}
document.getElementById("makeagig").addEventListener("click",makeagig);

</script>


</body>
</html>